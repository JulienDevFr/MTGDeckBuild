<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Commander Builder - Pro (Fichiers)</title>
    <style>
        :root { 
            --bg-dark: #0a0a0a; 
            --sidebar-bg: #151515; 
            --accent: #3498db; 
            --text: #eee;
            --border: #333;
            --success: #27ae60;
            --danger: #e74c3c;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        #sidebar { width: 350px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; }
        
        .file-ops { display: flex; gap: 5px; margin-bottom: 15px; }
        .btn-file { flex: 1; padding: 8px; border-radius: 4px; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 0.7em; }

        #commander-display { 
            width: 100%; height: 280px;
            background: #111; border-radius: 10px; border: 1px solid #333;
            margin: 10px 0; overflow: hidden; display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        #commander-display img { width: 100%; height: 100%; object-fit: contain; }
        .remove-cmd { position: absolute; top: 5px; right: 5px; background: var(--danger); border: none; color: white; border-radius: 3px; cursor: pointer; padding: 2px 6px; font-size: 10px; }

        .deck-info { margin-bottom: 10px; }
        .deck-name { background: transparent; border: none; border-bottom: 1px solid var(--border); color: white; font-size: 1.2em; width: 100%; padding: 5px 0; outline: none; }

        /* --- TABS --- */
        #tabs-bar { 
            display: none; 
            background: #111; padding: 10px 20px 0; gap: 8px; border-bottom: 1px solid var(--border);
        }
        .tab { padding: 10px 15px; background: #222; border-radius: 5px 5px 0 0; cursor: pointer; color: #777; font-weight: bold; font-size: 0.8em; white-space: nowrap; }
        .tab.active { background: var(--accent); color: white; }

        /* --- GRILLE --- */
        .grid-container { flex-grow: 1; padding: 20px; overflow-y: auto; background: #0d0d0d; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card-miniature { cursor: pointer; transition: 0.2s; }
        .card-miniature:hover { transform: translateY(-5px); }
        .card-miniature img { width: 100%; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        #deck-list { flex-grow: 1; overflow-y: auto; margin-top: 10px; }
        .cat-title { font-size: 0.7em; color: var(--accent); text-transform: uppercase; margin-top: 12px; border-bottom: 1px solid #222; padding-bottom: 3px; display: flex; justify-content: space-between; font-weight: bold; }
        .card-row {
            display: flex;
            justify-content: space-between; /* Pousse le nom √† gauche et le nombre √† droite */
            align-items: center;
            padding: 5px 8px;
            font-size: 0.85em;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .card-row:hover { color: var(--danger); }

        /* Style pour la carte d√©j√† pr√©sente dans le deck */
        .card-miniature.selected img {
            border: 3px solid var(--success);
            box-shadow: 0 0 15px var(--success);
            filter: brightness(1.1);
        }

        /* Optionnel : un petit badge "Check" sur la carte */
        .card-miniature.selected::after {
            content: "‚úì";
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .basic-control {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 20px;
            z-index: 10;
            border: 1px solid var(--accent);
        }
        .basic-control button {
            background: var(--accent);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        .price-tag {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: #2ecc71;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            pointer-events: none;
        }
        .card-miniature { position: relative; }

        .mana-container { display: flex; gap: 2px; margin-right: 5px; min-width: 20px; }

        .mana-symbol {
            width: 14px; height: 14px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: #000;
            text-shadow: 0px 0px 2px rgba(255,255,255,0.5);
            box-shadow: inset 0 -1px 1px rgba(0,0,0,0.3);
        }

        /* Chiffres (gris/brun) */
        .mana-symbol:not(.s-w):not(.s-u):not(.s-b):not(.s-r):not(.s-g) {
            background: #ccc;
        }

        /* Style pour les cartes poss√©d√©es dans la collection */
        .in-collection img {
            border: 3px solid #8e44ad !important;
            box-shadow: 0 0 10px #8e44ad !important;
        }

        /* Badge "Poss√©d√©" */
        .owned-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #8e44ad;
            color: white;
            font-size: 8px; /* Plus petit pour les codes multiples */
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            z-index: 5;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #filter-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #111;
            padding: 10px 15px;
            border-bottom: 1px solid #222;
        }

        #filter-name {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            flex: 1; /* Prend l'espace restant */
        }

        .filter-group label { color: #888; margin-right: 5px; }

        /* BOUTON COULEUR */
            .f-color, .f-color-cmd {
                border-radius: 50%;
                border: 2px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
                transition: all 0.2s ease;
                padding: 0; /* Important pour les boutons sans texte */
            }

            [data-color="W"] { background-color: #fdfae1; }
            [data-color="U"] { background-color: #0e68ab; }
            [data-color="B"] { background-color: #333333; }
            [data-color="R"] { background-color: #d32f2f; }
            [data-color="G"] { background-color: #2e7d32; }
            [data-color="C"] { background-color: #999999; }

            /* Effet au survol commun */
            .f-color:hover, .f-color-cmd:hover {
                transform: translateY(-2px);
                border-color: rgba(255, 255, 255, 0.5);
            }

            .f-color.active, .f-color-cmd.active {
                border: 3px solid var(--success) !important;
                box-shadow: 0 0 15px var(--success);
                filter: brightness(1.1);
                transform: scale(1.2); 
                z-index: 5;
            }
            .f-color[data-color="W"].active, 
            .f-color-cmd[data-color="W"].active,
            .f-color[data-color="C"].active,
            .f-color-cmd[data-color="C"].active {
                /* On force une luminosit√© un peu moindre sur le fond du bouton 
                pour que le cadre vert "brille" davantage par contraste */
                filter: brightness(0.9) saturate(1.2); 
            }

            /* Lueurs sp√©cifiques bas√©es sur l'attribut data-color */
            [data-color="W"].active { box-shadow: 0 0 12px #fdfae1; }
            [data-color="U"].active { box-shadow: 0 0 12px #0e68ab; }
            [data-color="B"].active { box-shadow: 0 0 12px #333333; }
            [data-color="R"].active { box-shadow: 0 0 12px #d32f2f; }
            [data-color="G"].active { box-shadow: 0 0 12px #2e7d32; }
            [data-color="C"].active { box-shadow: 0 0 12px #999999; }

            /* Taille pour les filtres de la grille (Milieu) */
            .f-color {
                width: 28px;
                height: 28px;
            }

            /* Taille pour la recherche du commandant (Haut) */
            .f-color-cmd {
                width: 22px;
                height: 22px;
            }

        #filter-price-max {
            background: #222;
            border: 1px solid #444;
            color: #2ecc71;
            font-weight: bold;
            padding: 4px;
            border-radius: 4px;
            text-align: center;
        }

        .filter-toggle {
            background: #333;
            border: 1px solid #8e44ad;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: 0.2s;
        }

        .filter-toggle:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #444;
            filter: grayscale(1);
        }

        .filter-toggle.active {
            background: #8e44ad;
            box-shadow: 0 0 8px rgba(142, 68, 173, 0.5);
        }

        .btn-reset {
            background: #c0392b;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: auto; /* Pousse le bouton √† droite */
        }

        .btn-reset:hover { background: #e74c3c; }

        .replace-trigger {
            cursor: pointer;
            margin-left: 8px;
            font-size: 1.1em;
            filter: grayscale(1);
            transition: filter 0.2s, transform 0.2s;
        }

        .replace-trigger:hover {
            filter: grayscale(0);
            transform: scale(1.3);
        }
        .modal {
            display: none; 
            position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e1e1e;
            margin: 5% auto; padding: 20px;
            border: 1px solid #444; width: 80%; max-width: 900px;
            border-radius: 12px; color: white;
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .close-modal { font-size: 28px; cursor: pointer; color: #aaa; }

        /* Layout Interne */
        .replacement-container {
            display: flex; gap: 20px; margin-top: 20px;
        }

        .target-card-area {
            flex: 1; border-right: 1px solid #333; padding-right: 20px;
            text-align: center;
        }

        .suggestions-area { flex: 2; }

        .label { font-size: 0.75em; color: #888; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }

        /* Style des cartes de suggestion */
        .suggestion-item {
            display: flex; align-items: center; gap: 15px;
            background: #2a2a2a; padding: 10px; border-radius: 8px;
            margin-bottom: 10px; border: 1px solid #444; transition: 0.2s;
        }

        .suggestion-item:hover { border-color: #27ae60; background: #333; }

        .suggestion-info { flex: 1; }
        .suggestion-info h4 { margin: 0; color: #fff; }
        .suggestion-info .match-reason { font-size: 0.85em; color: #2ecc71; margin-top: 4px; }

        .btn-replace {
            background: #27ae60; color: white; border: none;
            padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        .btn-replace:hover { background: #2ecc71; }



        
    </style>
</head>
<body>

<aside id="sidebar">
    <div class="file-ops">
        <button class="btn-file" style="background:var(--accent)" onclick="document.getElementById('file-input').click()">üìÇ DECK</button>
        <button class="btn-file" style="background:#8e44ad" onclick="document.getElementById('collection-input').click()">üìö COLL.</button>
        <button class="btn-file" style="background:var(--success)" onclick="exportDeck()">üíæ SAUVER</button>
        
        <input type="file" id="file-input" style="display:none" accept=".txt">
        <input type="file" id="collection-input" style="display:none" accept=".txt,.csv">
    </div>

    <div class="deck-info">
        <input type="text" id="deck-name" class="deck-name" placeholder="Nom du Deck...">
        <div style="margin-top:10px; font-size:0.8em;">Cartes: <b id="count">0</b>/100</div>
    </div>

    <input type="text" id="commander-search" placeholder="Nom du commandant..." style="width:100%; padding:10px; background:#222; border:1px solid #333; color:white; border-radius:5px; outline:none; box-sizing: border-box;">

    <div id="commander-color-filters">
        <button class="f-color-cmd" data-color="W" title="Blanc" onclick="toggleCmdColor(this)"></button>
        <button class="f-color-cmd" data-color="U" title="Bleu" onclick="toggleCmdColor(this)"></button>
        <button class="f-color-cmd" data-color="B" title="Noir" onclick="toggleCmdColor(this)"></button>
        <button class="f-color-cmd" data-color="R" title="Rouge" onclick="toggleCmdColor(this)"></button>
        <button class="f-color-cmd" data-color="G" onclick="toggleCmdColor(this)"></button>
        <button class="f-color-cmd" data-color="C" title="Incolore" onclick="toggleCmdColor(this)"></button>
    </div>

    <div id="commander-display">
        <div style="color:#333; font-size:0.8em; text-align:center;">S√âLECTIONNEZ UN COMMANDANT</div>
    </div>

    <div id="deck-list"></div>
</aside>

<main style="flex-grow:1; display:flex; flex-direction:column;">
    <div id="filter-bar">
        <input type="text" id="filter-name" placeholder="Rechercher dans les r√©sultats..." oninput="applyFilters()">
        
        <button id="btn-filter-owned" class="filter-toggle" onclick="toggleOwnedFilter()" disabled title="Importez une collection pour utiliser ce filtre">
            üìö Poss√©d√©es uniquement
        </button>

        <div class="filter-group">
            <div id="filter-colors">
                <button class="f-color" data-color="W" title="Blanc" onclick="toggleFilterColor(this)"></button>
                <button class="f-color" data-color="U" title="Bleu" onclick="toggleFilterColor(this)"></button>
                <button class="f-color" data-color="B" title="Noir" onclick="toggleFilterColor(this)"></button>
                <button class="f-color" data-color="R" title="Rouge" onclick="toggleFilterColor(this)"></button>
                <button class="f-color" data-color="G" title="Vert" onclick="toggleFilterColor(this)"></button>
                <button class="f-color" data-color="C" title="Incolore" onclick="toggleFilterColor(this)"></button>
            </div>
        </div>

        <div class="filter-group">
            <input type="number" id="filter-price-max" placeholder="Prix max" style="width:70px" oninput="applyFilters()">
        </div>

        <button class="btn-reset" onclick="resetFilters()">üîÑ Reset</button>
    </div>

    <div id="tabs-bar">
        <div class="tab active" data-type="creature">Cr√©atures</div>
        <div class="tab" data-type="instant">Eph√©m√®res</div>
        <div class="tab" data-type="sorcery">Rituels</div>
        <div class="tab" data-type="artifact">Artefacts</div>
        <div class="tab" data-type="enchantment">Enchantements</div>
        <div class="tab" data-type="planeswalker">Planeswalker</div>
        <div class="tab" data-type="land_util">Terrains utilitaires</div>
        <div class="tab" data-type="land">Terrains</div>
    </div>
    
    <div class="grid-container">
        <div class="card-grid" id="card-grid"></div>
    </div>

<div id="replacement-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Remplacer par une carte poss√©d√©e</h2>
            <span class="close-modal" onclick="closeReplacementModal()">&times;</span>
        </div>
        
        <div class="modal-body">
            <div class="replacement-container">
                
                <div class="target-card-area">
                    <p class="label">CARTE MANQUANTE</p>
                    <div id="target-card-display">
                        </div>
                </div>

                <div class="suggestions-area">
                    <p class="label">SUGGESTIONS DANS VOTRE COLLECTION</p>
                    <div id="suggestions-list">
                        </div>
                </div>

            </div>
        </div>
    </div>
</div>


</main>

<script>
    let deck = { name: "", commander: null, cards: [] };
    let currentTab = "creature";
    let lastSearchResults = [];
    let selectedCommanderColors = new Set();
    let activeFilterColors = new Set();
    let myCollection = new Map();
    let showOnlyOwned = false;

    document.querySelectorAll('.f-color-cmd').forEach(btn => {
        btn.onclick = () => {
            // Si un commandant est d√©j√† choisi, on ne change plus les filtres manuellement
            if (deck.commander) return;

            const color = btn.dataset.color;

            if (color === "C") {
                // Si on clique sur Incolore, on √©teint tout le reste
                document.querySelectorAll('.f-color-cmd').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            } else {
                // Si on clique sur une couleur, on √©teint Incolore
                const btnC = document.querySelector('.f-color-cmd[data-color="C"]');
                if (btnC) btnC.classList.remove('active');
                btn.classList.toggle('active');
            }
            searchByColor();
        };
    });

    async function searchByColor() {
        const activeButtons = Array.from(document.querySelectorAll('.f-color-cmd.active'));
        const activeColors = activeButtons.map(b => b.dataset.color);
        
        if (activeColors.length === 0) {
            document.getElementById('card-grid').innerHTML = '';
            return;
        }

        let q = "is:commander ";
        // identity=c pour incolore, sinon identity=WUBRG...
        q += activeColors.includes("C") ? "identity=c" : `identity=${activeColors.join('')}`;

        const r = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(q)}&order=edhrec`);
        const d = await r.json();
        if (d.data) renderGrid(d.data, true);
    }

        // --- RECHERCHE COMMANDANT ---
    document.getElementById('commander-search').addEventListener('input', async (e) => {
        const val = e.target.value;
        if (deck.commander) return;

        if (val.length < 3) {
            // Si le champ est trop court, on relance la recherche par couleur 
            // pour ne pas laisser une grille vide ou bloqu√©e
            searchByColor();
            return;
        }

        const r = await fetch(`https://api.scryfall.com/cards/search?q=is:commander+name:/${encodeURIComponent(val)}/`);
        const d = await r.json();
        if (d.data) renderGrid(d.data, true);
    });

    function selectCommander(cardData) {
        const img = cardData.image_uris?.normal || cardData.card_faces?.[0]?.image_uris?.normal;
        const price = cardData.prices?.eur || 0;
        deck.commander = { name: cardData.name, identity: cardData.color_identity, img: img, price: price };
        updateColorFilterButtons();
        // On vide la recherche
        document.getElementById('commander-search').value = '';
        // On allume les pastilles de couleur correspondant au commandant
        document.querySelectorAll('.f-color-cmd').forEach(btn => {
            const color = btn.dataset.color;
            const isActive = cardData.color_identity.includes(color);
            btn.classList.toggle('active', isActive);
        });
        // Si le commandant est incolore (ex: Hope of Ghirapur)
        if (cardData.color_identity.length === 0) {
            const btnC = document.querySelector('.f-color-cmd[data-color="C"]');
            if (btnC) btnC.classList.add('active');
        }
        refreshCommanderView();
        updateUI();
        loadCards(); // Charge les cartes de l'onglet par d√©faut (souvent cr√©atures)
    }

    function updateColorFilterButtons() {
        if (!deck.commander) return;
        const identity = deck.commander.identity; // Ex: ['G', 'R']
        // 1. FILTRE RECHERCHE (Grille centrale)
        document.querySelectorAll('.f-color').forEach(btn => {
            const color = btn.dataset.color;
            if (color === "C" || identity.includes(color)) {
                btn.style.display = "inline-flex";
            } else {
                btn.style.display = "none";
                btn.classList.remove('active'); // S√©curit√© : on d√©coche si c'√©tait actif
            }
        });
        // 2. INDICATEURS COMMANDANT (Colonne de gauche)
        document.querySelectorAll('.f-color-cmd').forEach(btn => {
            const color = btn.dataset.color;
            if (identity.includes(color)) {
                btn.style.display = "inline-flex";
                btn.classList.add('active');      // On les laisse allum√©es pour le style
                btn.style.pointerEvents = "none";  // Emp√™che de cliquer dessus (devenu purement visuel)
            } else {
                btn.style.display = "none";
            }
        });
    }

    function removeCommander() {
        if (!confirm("Retirer le commandant videra aussi votre deck actuel. Continuer ?")) return;
            deck.commander = null;
            deck.cards = [];
            const searchInput = document.getElementById('commander-search');
            searchInput.value = ''; 
            searchInput.focus();
            document.getElementById('commander-display').innerHTML = '<div style="color:#333; font-size:0.8em; text-align:center;">S√âLECTIONNEZ UN COMMANDANT</div>';
            document.getElementById('tabs-bar').style.display = 'none';
            document.getElementById('card-grid').innerHTML = '';
            document.querySelectorAll('.f-color').forEach(btn => {
                btn.style.display = "inline-flex"; // On r√©affiche
                btn.classList.remove('active');    // On d√©coche
            });
            document.querySelectorAll('.f-color-cmd').forEach(btn => {
                btn.style.display = "inline-flex"; // On r√©affiche
                btn.classList.remove('active');    // On d√©coche
            });
            updateUI();
    }

    function refreshCommanderView() {
        if (deck.commander) {
            document.getElementById('commander-display').innerHTML = `
                <img src="${deck.commander.img}">
                <button class="remove-cmd" onclick="removeCommander()">‚ùå</button>
            `;
            document.getElementById('tabs-bar').style.display = 'flex';
        }
    }

    // --- CARTES DU DECK ---
    function getTotalCount() {
        let count = deck.cards.reduce((acc, c) => acc + (c.count || 1), 0);
        if (deck.commander) {
            count += 1;
        }
    return count;
}

    async function loadCards() {
        if (!deck.commander) return;
        const id = deck.commander.identity;
        const idQuery = id.length === 0 ? 'id:c' : `id<=${id.join('')}`;
        let subQuery = "";
        if (currentTab === "land_util") {
            subQuery = "t:land -is:basic -produces>1";
        } 
        else if (currentTab === "land") {
            subQuery = "t:land (is:basic OR produces>1)";
        } 
        else if (currentTab === "artifact") {
            subQuery = "t:artifact -t:creature -t:land";
        }
        else if (currentTab === "enchantment") {
            subQuery = "t:enchantment -t:creature";
        }
        else {
            subQuery = `t:${currentTab}`;
        }
        const q = `f:edh ${idQuery} (${subQuery}) -is:digital`;
        const r = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(q)}&order=edhrec`);
        const d = await r.json();
        let cardsToShow = d.data || [];
        if (currentTab === "land") {
            const baseNamesMap = { 'W': 'Plains', 'U': 'Island', 'B': 'Swamp', 'R': 'Mountain', 'G': 'Forest' };
            let baseSearchNames = id.length === 0 ? ["Wastes"] : id.map(color => baseNamesMap[color]);
            const baseQuery = `t:basic (${baseSearchNames.join(' OR ')})`;
            const rBase = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(baseQuery)}`);
            const dBase = await rBase.json();
            if (dBase.data) {
                const filteredMainResults = cardsToShow.filter(c => !c.type_line.includes('Basic'));
                const order = { 'Plains': 1, 'Island': 2, 'Swamp': 3, 'Mountain': 4, 'Forest': 5, 'Wastes': 6 };
                const sortedBases = dBase.data.sort((a, b) => (order[a.name] || 9) - (order[b.name] || 9));
                cardsToShow = [...sortedBases, ...filteredMainResults];
            }
        }
        renderGrid(cardsToShow, false);
    }

    function renderGrid(cards, isSearchingCommander) {
        // Si on cherche un commandant, on ignore les filtres et on affiche tout
        if (isSearchingCommander) {
            renderGridContent(cards, true);
            return;
        }
        // Sinon, on stocke et on filtre
        lastSearchResults = cards;
        applyFilters();
    }


    // Alterne le filtre de collection
    function toggleOwnedFilter() {
        showOnlyOwned = !showOnlyOwned;
        const btn = document.getElementById('btn-filter-owned');
        btn.classList.toggle('active', showOnlyOwned);
        applyFilters();
    }

    function toggleFilterColor(btn) {
        const color = btn.getAttribute('data-color'); // R√©cup√®re "W", "U", "R"...
        
        if (activeFilterColors.has(color)) {
            activeFilterColors.delete(color);
            btn.classList.remove('active');
        } else {
            activeFilterColors.add(color);
            btn.classList.add('active');
        }

        applyFilters();
    }

    function resetFilters() {
        document.getElementById('filter-name').value = '';
        document.getElementById('filter-price-max').value = '';
        activeFilterColors.clear();
        document.querySelectorAll('.f-color').forEach(btn => btn.classList.remove('active'));
        showOnlyOwned = false;
        const btnOwned = document.getElementById('btn-filter-owned');
        btnOwned.classList.remove('active');
        applyFilters();
    }

    function applyFilters() {
        if (!lastSearchResults || lastSearchResults.length === 0) return;
            const nameQuery = document.getElementById('filter-name').value.toLowerCase();
            const priceMax = parseFloat(document.getElementById('filter-price-max').value) || Infinity;
            const filtered = lastSearchResults.filter(c => {
            // 1. Filtre Nom
            const matchName = c.name.toLowerCase().includes(nameQuery);
            // 2. Filtre Prix
            const price = parseFloat(c.prices?.eur || 0);
            const matchPrice = price <= priceMax;
            // 3. Filtre Collection (NOUVEAU)
            const matchOwned = !showOnlyOwned || myCollection.has(c.name);
            // 4. Filtre Couleur
            let matchColor = true;
            if (activeFilterColors.size > 0) {
                const cardColors = c.colors || [];
                if (activeFilterColors.has('C')) {
                    matchColor = cardColors.length === 0;
                } else {
                    matchColor = cardColors.length === activeFilterColors.size && cardColors.every(col => activeFilterColors.has(col));
                }
            }
            return matchName && matchPrice && matchColor && matchOwned;
        });
        renderGridContent(filtered, false);
    }


    function renderGridContent(cards, isSearchingCommander) {
        const grid = document.getElementById('card-grid');
        grid.innerHTML = '';
        // S√©curit√© : si cards est ind√©fini
        if (!cards) return;
        cards.forEach(c => {
            const div = document.createElement('div');
            div.className = 'card-miniature';
            // --- V√âRIFICATION COLLECTION ET √âDITIONS ---
            // Utilisation de ?. au cas o√π myCollection n'est pas encore initialis√©
            const ownedSets = myCollection?.get(c.name); 
            const isOwned = ownedSets !== undefined;
            if (isOwned) div.classList.add('in-collection');
            // V√©rification pr√©sence dans le deck
            const deckCard = deck.cards.find(x => x.name === c.name);
            if (deckCard) div.classList.add('selected');
            const imgUrl = c.image_uris?.normal || c.card_faces?.[0]?.image_uris?.normal;
            const price = c.prices?.eur ? `${c.prices.eur}‚Ç¨` : "N/A";
            if (!imgUrl) return;
            let htmlContent = `<img src="${imgUrl}" loading="lazy"><div class="price-tag">${price}</div>`;
            if (isOwned) {
                const setsList = Array.from(ownedSets).join(', ');
                htmlContent += `<div class="owned-badge">${setsList}</div>`;
            }
            const isBasic = c.type_line && c.type_line.includes('Basic');
            if (isBasic && !isSearchingCommander) {
                const count = deckCard ? deckCard.count : 0;
                // On utilise une version plus simple de l'injection d'objet pour √©viter les erreurs JSON
                htmlContent = `
                    <div class="basic-control">
                        <button onclick="event.stopPropagation(); changeBasicCount('${c.name}', -1)">-</button>
                        <span>${count}</span>
                        <button onclick="event.stopPropagation(); changeBasicCount('${c.name}', 1)">+</button>
                    </div>` + htmlContent;
            }
            div.innerHTML = htmlContent;
            div.onclick = () => isSearchingCommander ? selectCommander(c) : addCard(c);
            grid.appendChild(div);
        });
    }

    function changeBasicCount(name, delta) {
        const cardMock = { 
            name: name, 
            type_line: 'Basic Land', 
            prices: { eur: "0.05" }, 
            mana_cost: "",
            keywords: [],
            oracle_text: ""
        };
        addCard(cardMock, delta);
    }

    function addCard(c, countChange = 1) {
        const isBasic = c.type_line && c.type_line.includes('Basic');
        const index = deck.cards.findIndex(x => x.name === c.name);
        
        let manaCost = c.mana_cost;
        let oracleText = c.oracle_text || "";
        let keywords = c.keywords || [];

        if (manaCost === undefined && c.card_faces) {
            manaCost = c.card_faces[0].mana_cost;
            oracleText = c.card_faces[0].oracle_text;
        }
        
        const price = parseFloat(c.prices?.eur || 0);
        const cmc = c.cmc || 0;

        if (isBasic) {
            if (index > -1) {
                if (countChange > 0 && getTotalCount() >= 100) return alert("Deck plein !");
                deck.cards[index].count += countChange;
                if (deck.cards[index].count <= 0) deck.cards.splice(index, 1);
            } else if (countChange > 0) {
                if (getTotalCount() >= 100) return alert("Deck plein !");
                deck.cards.push({ 
                    name: c.name, type: c.type_line, isNormalLand: true, 
                    count: 1, cmc: 0, price: price, manaCost: "", 
                    keywords: [], oracle: "" // Les bases n'en ont pas besoin
                });
            }
        } else {
            if (index > -1) {
                deck.cards.splice(index, 1);
            } else {
                if (getTotalCount() >= 100) return alert("Deck plein !");
                const isLand = c.type_line.includes('Land');
                
                deck.cards.push({ 
                    name: c.name, 
                    type: c.type_line, 
                    isNormalLand: isLand, 
                    count: 1, 
                    cmc: cmc, 
                    price: price, 
                    manaCost: manaCost,
                    keywords: keywords, // Stocke ["Flying", "Lifelink", etc.]
                    oracle: oracleText   // Utile pour la production de mana
                });
            }
        }
        updateUI();
        applyFilters(); 
    }

    function formatMana(cost) {
        if (!cost) return "";
        return cost.replace(/{(.*?)}/g, (match, symbol) => {
            let colorClass = symbol.toLowerCase().replace("/", ""); // g√®re les hybrid mana comme {W/U}
            return `<span class="mana-symbol s-${colorClass}">${symbol}</span>`;
        });
    }

    function removeCard(name) {
        const i = deck.cards.findIndex(x => x.name === name);
        if (i > -1) {
            deck.cards.splice(i, 1);
            updateUI();
            renderGrid(lastSearchResults, false); // <--- CRUCIAL pour retirer le contour vert
        }
    }

    function updateUI() {
        const list = document.getElementById('deck-list');
        const totalQty = getTotalCount();
        
        const commanderPrice = (deck.commander && deck.commander.price) ? parseFloat(deck.commander.price) : 0;
        const totalPrice = deck.cards.reduce((acc, c) => acc + (c.price * (c.count || 1)), commanderPrice);
        
        const countElement = document.getElementById('count');
        if (countElement) {
            countElement.innerHTML = `${totalQty}/100 | <span style="color:var(--success)">${totalPrice.toFixed(2)}‚Ç¨</span>`;
        }
      
        list.innerHTML = '';
        const groups = { 'Cr√©atures': [], 'Planeswalker': [], 'Eph√©m√®res': [], 'Rituels' : [], 'Terrains Utilitaires': [], 'Terrains': [], 'Artefacts': [], 'Enchantements': [] };
        
        deck.cards.forEach(card => {
            const tl = card.type;
            if (tl.includes('Creature')) groups['Cr√©atures'].push(card);
            else if (tl.includes('Land')) {
                if (card.isNormalLand) {
                    if (tl.includes('Basic')) groups['Terrains'].unshift(card);
                    else groups['Terrains'].push(card);
                } else groups['Terrains Utilitaires'].push(card);
            }
            else if (tl.includes('Artifact') && !tl.includes('Creature') && !tl.includes('Land')) groups['Artefacts'].push(card);
            else if (tl.includes('Planeswalker')) groups['Planeswalker'].push(card);
            else if (tl.includes('Instant')) groups['Eph√©m√®res'].push(card);
            else if (tl.includes('Sorcery')) groups['Rituels'].push(card);
            else if (tl.includes('Enchantment')) groups['Enchantements'].push(card);
        });

        for (let key in groups) {
            groups[key].sort((a, b) => a.cmc - b.cmc);
            }

        for (const [label, cards] of Object.entries(groups)) {
            if (cards.length > 0) {
                list.innerHTML += `<div class="cat-title"><span>${label}</span></div>`;
                cards.forEach(x => {
                   const qty = x.count && x.count > 1 ? `${x.count}x ` : "";
                    const linePrice = (x.price * (x.count || 1)).toFixed(2);
                    const manaHtml = formatMana(x.manaCost);
                    const ownedSets = myCollection.get(x.name);
                    const isMissing = myCollection.size > 0 && !ownedSets;
                    const rowStyle = isMissing ? 'color: #e74c3c; opacity: 0.8;' : '';
                    const missingMarker = isMissing ? '<span title="Manquante dans la collection" style="margin-right:5px;">‚ö†Ô∏è</span>' : '';
                    const isBasic = x.type && x.type.includes('Basic');
                    
                    let setsInfo = (ownedSets && !isBasic) 
                        ? `<small style="color:#8e44ad; margin-left:5px;">(${Array.from(ownedSets).join('/')})</small>` 
                        : "";

                    const replacementBtn = (isMissing && !isBasic) 
                        ? `<span class="replace-trigger" onclick="event.stopPropagation(); openReplacementModal('${x.name.replace(/'/g, "\\'")}')" title="Trouver un remplacement">üí°</span>` 
                        : "";

                    list.innerHTML += `
                        <div class="card-row" onclick="removeCard('${x.name.replace(/'/g, "\\'")}')" style="${rowStyle}">
                            <span style="flex:1; display:flex; align-items:center; gap:5px;">
                                <span class="mana-container">${manaHtml}</span>
                                <span>${qty}${x.name}${setsInfo} ${replacementBtn}</span>
                            </span>
                            <span style="color:#aaa; font-size:0.85em;">${x.price > 0 ? linePrice + '‚Ç¨' : '-'}</span>
                        </div>`;
                });
            }
        }
    }


    document.getElementById('collection-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/);
            myCollection.clear();
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                // Regex pour g√©rer les virgules dans les noms
                const columns = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                if (columns.length > 1) {
                    let cardName = columns[0].replace(/"/g, "").trim();
                    let setCode = columns[1].replace(/"/g, "").toUpperCase().trim(); // Colonne Set code
                    
                    if (cardName) {
                        if (!myCollection.has(cardName)) {
                            myCollection.set(cardName, new Set());
                        }
                        myCollection.get(cardName).add(setCode);
                    }
                }
            }
            // --- ACTIVATION DU BOUTON DE FILTRE ---
            const btnOwned = document.getElementById('btn-filter-owned');
            if (btnOwned) {
                if (myCollection.size > 0) {
                    btnOwned.disabled = false;
                    btnOwned.title = "Filtrer par cartes poss√©d√©es";
                } else {
                    btnOwned.disabled = true;
                }
            }            // --------------------------------------
            updateUI();
            renderGrid(lastSearchResults, false);
        };
        reader.readAsText(file);
    });



    function openReplacementModal(cardName) {
        const modal = document.getElementById('replacement-modal');
        if (!modal) return; // S√©curit√© si le HTML n'est pas encore l√†

        const card = deck.cards.find(c => c.name === cardName);
        if (!card) return;

        // On remplit les infos de la carte cible
        document.getElementById('target-card-display').innerHTML = `
            <div style="text-align:center;">
                <img src="https://api.scryfall.com/cards/named?exact=${encodeURIComponent(card.name)}&format=image" 
                    style="width:200px; border-radius:10px; border: 2px solid #e74c3c;">
                <h3>${card.name}</h3>
                <p style="font-size:0.9em; color:#888;">${card.type}</p>
            </div>
        `;

        // Reset de la liste des suggestions avant le calcul
        document.getElementById('suggestions-list').innerHTML = `
            <div style="padding:20px; text-align:center; color:#888;">
                Analyse de votre collection pour remplacer "${card.name}"...
            </div>
        `;

        modal.style.display = "block";
        findReplacements(card);
    }

    function closeReplacementModal() {
        document.getElementById('replacement-modal').style.display = "none";
    }

    // Fermer si on clique en dehors
    window.onclick = function(event) {
        const modal = document.getElementById('replacement-modal');
        if (event.target == modal) closeReplacementModal();
    }

    async function findReplacements(targetCard) {
        const listContainer = document.getElementById('suggestions-list');
        if (!listContainer) return;

        listContainer.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <div class="loader"></div> 
                <p style="color:#888; margin-top:10px;">Analyse des synergies dans votre collection...</p>
            </div>
        `;

        const identity = (deck.commander && deck.commander.identity) ? deck.commander.identity.join('') : 'c';
        const cleanIdentity = identity === '' ? 'c' : identity;
        const primaryType = targetCard.type.split('‚Äî')[0].trim();
        
        let queryParts = [
            `id<=${cleanIdentity}`,      // Respect de l'identit√© couleur
            `t:"${primaryType}"`,        // M√™me type principal
            `cmc>=${targetCard.cmc - 1}`, // Courbe de mana proche
            `cmc<=${targetCard.cmc + 1}`,
            `-name:"${targetCard.name}"`  // Exclure la carte elle-m√™me
        ];

        if (targetCard.type.includes("Creature") && targetCard.keywords && targetCard.keywords.length > 0) {
            queryParts.push(`o:"${targetCard.keywords[0]}"`);
        }

        if (targetCard.type.includes("Land") && targetCard.oracle) {
            const colors = ["W", "U", "B", "R", "G"];
            colors.forEach(col => {
                if (targetCard.oracle.includes(`{${col}}`)) {
                    queryParts.push(`produces:${col}`);
                }
            });
        }

        const finalQuery = queryParts.join(' ');

        try {
            const response = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(finalQuery)}&order=edhrec`);
            const data = await response.json();

            if (!data.data || data.data.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">Aucune alternative directe trouv√©e dans la base Scryfall.</p>';
                return;
            }

            const deckCardNames = new Set(deck.cards.map(c => c.name));
            const ownedSuggestions = data.data.filter(scryCard => {
                const isOwned = myCollection.has(scryCard.name);
                const isInDeck = deckCardNames.has(scryCard.name);
                return isOwned && !isInDeck;
            });

            if (ownedSuggestions.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">Vous poss√©dez des alternatives, mais elles sont d√©j√† toutes dans votre deck !</p>';
                return;
            }

            listContainer.innerHTML = '';
            ownedSuggestions.slice(0, 5).forEach(suggested => {
                const ownedSets = Array.from(myCollection.get(suggested.name)).join(', ');
                const imgUrl = suggested.image_uris ? suggested.image_uris.small : (suggested.card_faces ? suggested.card_faces[0].image_uris.small : '');

                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <img src="${imgUrl}" alt="${suggested.name}" style="width:60px; border-radius:4px; box-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                    <div class="suggestion-info">
                        <h4>${suggested.name}</h4>
                        <div class="match-reason">
                            ${suggested.mana_cost ? formatMana(suggested.mana_cost) : ''} 
                            <span style="margin-left:5px;">CMC ${suggested.cmc}</span>
                        </div>
                        <div style="font-size:0.75em; color:var(--accent); margin-top:3px;">Poss√©d√© en : ${ownedSets}</div>
                    </div>
                    <button class="btn-replace" onclick="executeReplacement('${targetCard.name.replace(/'/g, "\\'")}', '${suggested.name.replace(/'/g, "\\'")}')">
                        √âCHANGER
                    </button>
                `;
                listContainer.appendChild(item);
            });

        } catch (error) {
            console.error("Erreur findReplacements:", error);
            listContainer.innerHTML = '<p style="text-align:center; color:var(--danger);">Erreur de connexion √† Scryfall.</p>';
        }
    }


    async function executeReplacement(oldName, newName) {
        // 1. Retirer l'ancienne carte
        const oldIndex = deck.cards.findIndex(c => c.name === oldName);
        if (oldIndex > -1) deck.cards.splice(oldIndex, 1);

        // 2. Chercher les donn√©es compl√®tes de la nouvelle carte pour l'ajouter proprement
        const r = await fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(newName)}`);
        const cardData = await r.json();

        if (cardData) {
            // On r√©utilise ta logique d'ajout
            const isLand = cardData.type_line.includes('Land');
            deck.cards.push({ 
                name: cardData.name, 
                type: cardData.type_line, 
                isNormalLand: isLand, 
                count: 1, 
                cmc: cardData.cmc || 0, 
                price: parseFloat(cardData.prices?.eur || 0), 
                manaCost: cardData.mana_cost 
            });
            
            closeReplacementModal();
            updateUI();
            applyFilters(); // Pour mettre √† jour le contour vert dans la grille
        }
    }


    // --- FICHIERS ---
    function exportDeck() {
        deck.name = document.getElementById('deck-name').value || "Nouveau Deck";
        const content = JSON.stringify(deck, null, 2);
        const blob = new Blob([content], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${deck.name}.txt`;
        a.click();
    }

    document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                deck = JSON.parse(e.target.result);
                document.getElementById('deck-name').value = deck.name;
                refreshCommanderView();
                updateColorFilterButtons();
                updateUI();
                if (deck.commander) {
                    document.querySelectorAll('.f-color-cmd').forEach(btn => {
                        const color = btn.dataset.color;
                        const isActive = deck.commander.identity.includes(color);
                        btn.classList.toggle('active', isActive);
                    });
                    if (deck.commander.identity.length === 0) {
                        const btnC = document.querySelector('.f-color-cmd[data-color="C"]');
                        if (btnC) btnC.classList.add('active');
                    }
                    loadCards();
                }
            } catch (err) { 
                console.error(err);
                alert("Erreur : Fichier de deck invalide."); 
            }
        };
        reader.readAsText(file);
    });

    document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            currentTab = t.dataset.type;
            loadCards();
        }
    });
</script>
</body>
</html>